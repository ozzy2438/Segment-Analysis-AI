<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smart Customer Segmentation and Data Analysis Platform</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/papaparse@5.3.2/papaparse.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.15.4/css/all.min.css" rel="stylesheet">
</head>
<body class="bg-gray-50 min-h-screen">
    <header class="bg-gradient-to-r from-blue-600 to-indigo-800 text-white shadow-lg">
        <div class="container mx-auto py-6 px-4">
            <h1 class="text-3xl font-bold mb-2">Smart Customer Segmentation and Data Analysis Platform</h1>
            <p class="text-blue-100">OpenAI API powered dynamic customer analysis and marketing recommendations</p>
        </div>
    </header>

    <main class="container mx-auto py-8 px-4">
        <!-- File Upload Section -->
        <section class="mb-12 bg-white rounded-lg shadow-md p-6">
            <h2 class="text-2xl font-bold mb-4 text-gray-800">Data Upload</h2>
            <div class="flex flex-col md:flex-row items-start gap-8">
                <div class="w-full md:w-1/2">
                    <div class="border-2 border-dashed border-blue-300 rounded-lg p-8 text-center bg-blue-50 hover:bg-blue-100 transition-colors cursor-pointer" id="dropZone">
                        <i class="fas fa-cloud-upload-alt text-5xl text-blue-500 mb-4"></i>
                        <p class="text-gray-700 mb-2">Drag and drop your file or select</p>
                        <p class="text-sm text-gray-500 mb-4">CSV, Excel, JSON formats are supported</p>
                        <input type="file" id="fileInput" class="hidden" accept=".csv,.xlsx,.xls,.json">
                        <button class="bg-blue-600 hover:bg-blue-700 text-white font-medium py-2 px-6 rounded-md transition-colors" id="browseButton">
                            Select File
                        </button>
                    </div>
                    <div class="mt-4 flex justify-between items-center">
                        <p class="text-sm text-gray-600" id="fileInfo">No file selected yet</p>
                        <button class="bg-green-600 hover:bg-green-700 text-white font-medium py-2 px-6 rounded-md transition-colors hidden" id="analyzeButton">
                            Analyze
                        </button>
                    </div>
                </div>

                <div class="w-full md:w-1/2 mt-6 md:mt-0">
                    <div class="bg-gray-100 rounded-lg p-4">
                        <h3 class="text-lg font-semibold mb-3 flex items-center">
                            <i class="fas fa-cog text-gray-600 mr-2"></i> 
                            Analysis Settings
                        </h3>
                        <div class="mb-4">
                            <label class="block text-sm font-medium text-gray-700 mb-1">Number of Segments</label>
                            <select id="clusterCount" class="w-full rounded-md border-gray-300 shadow-sm py-2 px-3 bg-white border">
                                <option value="3">3 Segments</option>
                                <option value="4">4 Segments</option>
                                <option value="5" selected>5 Segments</option>
                                <option value="6">6 Segments</option>
                                <option value="7">7 Segments</option>
                                <option value="auto">Determine Automatically</option>
                            </select>
                        </div>

                        <div class="mb-4">
                            <label class="block text-sm font-medium text-gray-700 mb-1">API Integration</label>
                            <div class="relative">
                                <input type="text" id="apiKey" placeholder="OpenAI API Key" class="w-full rounded-md border-gray-300 shadow-sm py-2 px-3 bg-white border">
                                <div class="absolute inset-y-0 right-0 flex items-center pr-3">
                                    <i class="fas fa-key text-gray-400"></i>
                                </div>
                            </div>
                            <p class="mt-1 text-xs text-gray-500">OpenAI API key is required for smart analysis</p>
                        </div>

                        <div class="flex items-center mb-2">
                            <input type="checkbox" id="advancedAnalysis" class="rounded text-blue-600 mr-2" checked>
                            <label for="advancedAnalysis" class="text-sm text-gray-700">Advanced Segment Analysis</label>
                        </div>

                        <div class="flex items-center">
                            <input type="checkbox" id="marketingRecommendations" class="rounded text-blue-600 mr-2" checked>
                            <label for="marketingRecommendations" class="text-sm text-gray-700">Generate Marketing Recommendations</label>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Loading Indicator -->
        <div id="loadingSection" class="hidden">
            <div class="flex flex-col items-center justify-center p-10 mb-12 bg-white rounded-lg shadow-md">
                <div class="w-16 h-16 border-4 border-blue-500 border-t-transparent rounded-full animate-spin mb-4"></div>
                <p class="text-lg text-gray-700 font-medium" id="loadingText">Analyzing data...</p>
                <p class="text-sm text-gray-500 mt-2" id="loadingSubText">This process may take a few minutes</p>
                <div class="w-full max-w-md bg-gray-200 rounded-full h-2.5 mt-4">
                    <div class="bg-blue-600 h-2.5 rounded-full" id="progressBar" style="width: 10%"></div>
                </div>
            </div>
        </div>

        <!-- Data Preview Section -->
        <section id="dataPreviewSection" class="mb-12 bg-white rounded-lg shadow-md p-6 hidden">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-2xl font-bold text-gray-800">Data Preview</h2>
                <div class="flex items-center">
                    <span class="text-sm text-gray-500 mr-2">Row count: <span id="rowCount" class="font-medium">0</span></span>
                    <span class="text-sm text-gray-500 ml-2">Column count: <span id="columnCount" class="font-medium">0</span></span>
                </div>
            </div>
            
            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200" id="dataPreviewTable">
                    <thead class="bg-gray-50">
                        <tr id="tableHeader"></tr>
                    </thead>
                    <tbody class="bg-white divide-y divide-gray-200" id="tableBody">
                    </tbody>
                </table>
            </div>
            
            <p class="mt-4 text-sm text-gray-500">First 10 rows are displayed. Analysis will be performed on the entire dataset.</p>
        </section>

        <!-- Segmentation Results -->
        <section id="segmentationSection" class="mb-12 bg-white rounded-lg shadow-md p-6 hidden">
            <h2 class="text-2xl font-bold mb-6 text-gray-800">Segmentation Results</h2>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                <!-- Segment Distribution Chart -->
                <div class="bg-gray-50 rounded-lg p-4 shadow-sm">
                    <h3 class="text-lg font-semibold mb-3">Segment Distribution</h3>
                    <div class="aspect-w-4 aspect-h-3">
                        <canvas id="segmentDistributionChart" class="w-full h-full"></canvas>
                    </div>
                </div>
                
                <!-- Segment Feature Importance -->
                <div class="bg-gray-50 rounded-lg p-4 shadow-sm">
                    <h3 class="text-lg font-semibold mb-3">Important Features</h3>
                    <div class="aspect-w-4 aspect-h-3">
                        <canvas id="featureImportanceChart" class="w-full h-full"></canvas>
                    </div>
                </div>
            </div>
            
            <div class="mt-8">
                <h3 class="text-lg font-semibold mb-4">Segment Profiles</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4" id="segmentProfiles">
                    <!-- Segment cards will be generated here dynamically -->
                </div>
            </div>
        </section>

        <!-- Marketing Recommendations Section -->
        <section id="recommendationsSection" class="mb-12 bg-white rounded-lg shadow-md p-6 hidden">
            <h2 class="text-2xl font-bold mb-6 text-gray-800">Marketing Strategy Recommendations</h2>
            
            <div id="recommendationsTabs" class="border-b border-gray-200 mb-6">
                <!-- Tabs will be generated here dynamically -->
            </div>
            
            <div id="recommendationsContent">
                <!-- Recommendations content will be generated here dynamically -->
            </div>
        </section>

        <!-- Final Report -->
        <section id="reportSection" class="mb-12 bg-white rounded-lg shadow-md p-6 hidden">
            <h2 class="text-2xl font-bold mb-6 text-gray-800">Analysis Summary and Report</h2>
            
            <div class="prose max-w-none">
                <div id="reportContent">
                    <!-- Report will be generated here dynamically -->
                </div>
            </div>
        </section>
    </main>

    <footer class="bg-gray-800 text-gray-300">
        <div class="container mx-auto py-8 px-4">
            <div class="flex flex-col md:flex-row justify-between">
                <div class="mb-6 md:mb-0">
                    <h3 class="text-xl font-semibold text-white mb-3">Smart Customer Segmentation</h3>
                    <p class="text-gray-400 max-w-md">OpenAI API powered dynamic customer segmentation and marketing strategy recommendations platform.</p>
                </div>
                <div>
                    <h4 class="text-lg font-semibold text-white mb-3">Supported Formats</h4>
                    <ul class="text-gray-400">
                        <li class="mb-1"><i class="far fa-file-alt mr-2"></i> CSV files</li>
                        <li class="mb-1"><i class="far fa-file-excel mr-2"></i> Excel files (.xlsx, .xls)</li>
                        <li><i class="far fa-file-code mr-2"></i> JSON files</li>
                    </ul>
                </div>
            </div>
            <div class="mt-8 border-t border-gray-700 pt-6 text-center text-sm text-gray-500">
                <p>Â© 2023 Smart Customer Segmentation and Data Analysis Platform. All rights reserved.</p>
            </div>
        </div>
    </footer>

    <script>
        // Global variables
        let currentData = null;
        let segmentResults = null;
        let recommendationResults = null;
        const segmentColors = [
            'rgba(255, 99, 132, 0.8)',
            'rgba(54, 162, 235, 0.8)',
            'rgba(255, 206, 86, 0.8)',
            'rgba(75, 192, 192, 0.8)',
            'rgba(153, 102, 255, 0.8)',
            'rgba(255, 159, 64, 0.8)',
            'rgba(199, 199, 199, 0.8)',
            'rgba(83, 102, 255, 0.8)',
            'rgba(40, 159, 64, 0.8)',
            'rgba(210, 199, 199, 0.8)',
        ];

        // Elements
        const fileInput = document.getElementById('fileInput');
        const dropZone = document.getElementById('dropZone');
        const browseButton = document.getElementById('browseButton');
        const fileInfo = document.getElementById('fileInfo');
        const analyzeButton = document.getElementById('analyzeButton');
        const loadingSection = document.getElementById('loadingSection');
        const loadingText = document.getElementById('loadingText');
        const loadingSubText = document.getElementById('loadingSubText');
        const progressBar = document.getElementById('progressBar');
        const dataPreviewSection = document.getElementById('dataPreviewSection');
        const segmentationSection = document.getElementById('segmentationSection');
        const recommendationsSection = document.getElementById('recommendationsSection');
        const reportSection = document.getElementById('reportSection');
        const rowCount = document.getElementById('rowCount');
        const columnCount = document.getElementById('columnCount');
        const tableHeader = document.getElementById('tableHeader');
        const tableBody = document.getElementById('tableBody');
        const segmentProfiles = document.getElementById('segmentProfiles');
        const recommendationsTabs = document.getElementById('recommendationsTabs');
        const recommendationsContent = document.getElementById('recommendationsContent');
        const reportContent = document.getElementById('reportContent');
        const apiKeyInput = document.getElementById('apiKey');
        
        // Event listeners
        browseButton.addEventListener('click', () => {
            fileInput.click();
        });
        
        dropZone.addEventListener('click', () => {
            fileInput.click();
        });
        
        dropZone.addEventListener('dragover', (e) => {
            e.preventDefault();
            dropZone.classList.add('border-blue-500');
        });
        
        dropZone.addEventListener('dragleave', () => {
            dropZone.classList.remove('border-blue-500');
        });
        
        dropZone.addEventListener('drop', (e) => {
            e.preventDefault();
            dropZone.classList.remove('border-blue-500');
            
            if (e.dataTransfer.files.length) {
                handleFile(e.dataTransfer.files[0]);
            }
        });
        
        fileInput.addEventListener('change', () => {
            if (fileInput.files.length) {
                handleFile(fileInput.files[0]);
            }
        });
        
        analyzeButton.addEventListener('click', () => {
            if (currentData) {
                analyzeData();
            }
        });
        
        // File handling function
        function handleFile(file) {
            const fileName = file.name;
            const fileType = fileName.split('.').pop().toLowerCase();
            
            // Reset UI
            resetUI();
            fileInfo.textContent = `Selected file: ${fileName}`;
            analyzeButton.classList.remove('hidden');
            
            // Parse file based on its type
            if (fileType === 'csv') {
                parseCSV(file);
            } else if (fileType === 'xlsx' || fileType === 'xls') {
                parseExcel(file);
            } else if (fileType === 'json') {
                parseJSON(file);
            } else {
                fileInfo.textContent = 'Unsupported file format. Please upload a CSV, Excel, or JSON file.';
                fileInfo.classList.add('text-red-500');
                analyzeButton.classList.add('hidden');
            }
        }
        
        // Parse CSV file
        function parseCSV(file) {
            Papa.parse(file, {
                header: true,
                dynamicTyping: true,
                complete: function(results) {
                    currentData = results.data;
                    displayPreview();
                },
                error: function(error) {
                    console.error('CSV parsing error:', error);
                    fileInfo.textContent = 'Error occurred while parsing the CSV file.';
                    fileInfo.classList.add('text-red-500');
                }
            });
        }
        
        // Parse Excel file
        function parseExcel(file) {
            const reader = new FileReader();
            
            reader.onload = function(e) {
                const data = e.target.result;
                const workbook = XLSX.read(data, { type: 'binary' });
                
                // Get first sheet
                const sheetName = workbook.SheetNames[0];
                const worksheet = workbook.Sheets[sheetName];
                
                // Convert to JSON
                const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });
                
                // Convert to array of objects with headers
                const headers = jsonData[0];
                currentData = jsonData.slice(1).map(row => {
                    const rowData = {};
                    headers.forEach((header, index) => {
                        rowData[header] = row[index];
                    });
                    return rowData;
                });
                
                displayPreview();
            };
            
            reader.onerror = function() {
                fileInfo.textContent = 'Error occurred while reading the Excel file.';
                fileInfo.classList.add('text-red-500');
            };
            
            reader.readAsBinaryString(file);
        }
        
        // Parse JSON file
        function parseJSON(file) {
            const reader = new FileReader();
            
            reader.onload = function(e) {
                try {
                    const jsonData = JSON.parse(e.target.result);
                    
                    // Handle both array of objects or object with arrays
                    if (Array.isArray(jsonData)) {
                        currentData = jsonData;
                    } else {
                        // Try to convert object to array of objects
                        const keys = Object.keys(jsonData);
                        if (keys.length > 0 && Array.isArray(jsonData[keys[0]])) {
                            // Object with arrays structure
                            const arrayLength = jsonData[keys[0]].length;
                            currentData = [];
                            
                            for (let i = 0; i < arrayLength; i++) {
                                const item = {};
                                keys.forEach(key => {
                                    item[key] = jsonData[key][i];
                                });
                                currentData.push(item);
                            }
                        } else {
                            // Single object structure, convert to array with one item
                            currentData = [jsonData];
                        }
                    }
                    
                    displayPreview();
                } catch (error) {
                    console.error('JSON parsing error:', error);
                    fileInfo.textContent = 'Error occurred while parsing the JSON file.';
                    fileInfo.classList.add('text-red-500');
                }
            };
            
            reader.onerror = function() {
                fileInfo.textContent = 'Error occurred while reading the JSON file.';
                fileInfo.classList.add('text-red-500');
            };
            
            reader.readAsText(file);
        }
        
        // Display data preview
        function displayPreview() {
            if (!currentData || currentData.length === 0) {
                return;
            }
            
            // Show data preview section
            dataPreviewSection.classList.remove('hidden');
            
            // Update counts
            rowCount.textContent = currentData.length;
            
            // Get columns from the first item
            const columns = Object.keys(currentData[0]);
            columnCount.textContent = columns.length;
            
            // Clear existing table
            tableHeader.innerHTML = '';
            tableBody.innerHTML = '';
            
            // Add header row
            columns.forEach(column => {
                const th = document.createElement('th');
                th.textContent = column;
                th.className = 'px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider';
                tableHeader.appendChild(th);
            });
            
            // Add data rows (limited to 10)
            const previewData = currentData.slice(0, 10);
            previewData.forEach(row => {
                const tr = document.createElement('tr');
                
                columns.forEach(column => {
                    const td = document.createElement('td');
                    td.textContent = row[column] !== null && row[column] !== undefined ? row[column] : '';
                    td.className = 'px-6 py-4 whitespace-nowrap text-sm text-gray-500';
                    tr.appendChild(td);
                });
                
                tableBody.appendChild(tr);
            });
            
            // Enable analyze button
            analyzeButton.classList.remove('hidden');
        }
        
        // Analyze data
        function analyzeData() {
            if (!currentData || currentData.length === 0) {
                return;
            }
            
            // Show loading section
            loadingSection.classList.remove('hidden');
            analyzeButton.disabled = true;
            
            // Start the analysis process
            simulateAnalysis()
                .then(() => {
                    // Hide loading section
                    loadingSection.classList.add('hidden');
                    analyzeButton.disabled = false;
                    
                    // Perform actual analysis
                    performSegmentation();
                    generateRecommendations();
                    generateReport();
                    
                    // Show results sections
                    segmentationSection.classList.remove('hidden');
                    recommendationsSection.classList.remove('hidden');
                    reportSection.classList.remove('hidden');
                    
                    // Scroll to results
                    segmentationSection.scrollIntoView({
                        behavior: 'smooth',
                        block: 'start'
                    });
                })
                .catch(error => {
                    console.error('Analysis error:', error);
                    loadingSection.classList.add('hidden');
                    analyzeButton.disabled = false;
                    alert('An error occurred during data analysis. Please try again.');
                });
        }
        
        // Simulate analysis process with progress updates
        function simulateAnalysis() {
            return new Promise((resolve) => {
                const steps = [
                    { text: 'Analyzing data...', subText: 'Data preprocessing and cleaning', progress: 10 },
                    { text: 'Extracting customer features...', subText: 'Identifying important features', progress: 30 },
                    { text: 'Creating segments...', subText: 'Running K-Means algorithm', progress: 50 },
                    { text: 'Generating segment profiles...', subText: 'Analyzing with OpenAI API', progress: 70 },
                    { text: 'Preparing marketing recommendations...', subText: 'Creating segment-based strategies', progress: 85 },
                    { text: 'Generating report...', subText: 'Compiling results', progress: 95 }
                ];
                
                let currentStep = 0;
                
                function updateProgress() {
                    if (currentStep < steps.length) {
                        const step = steps[currentStep];
                        loadingText.textContent = step.text;
                        loadingSubText.textContent = step.subText;
                        progressBar.style.width = `${step.progress}%`;
                        currentStep++;
                        setTimeout(updateProgress, 800);
                    } else {
                        // Final step
                        loadingText.textContent = 'Completed!';
                        loadingSubText.textContent = 'Preparing results...';
                        progressBar.style.width = '100%';
                        setTimeout(resolve, 500);
                    }
                }
                
                updateProgress();
            });
        }
        
        // Reset UI
        function resetUI() {
            fileInfo.textContent = '';
            fileInfo.classList.remove('text-red-500');
            
            // Hide all result sections
            dataPreviewSection.classList.add('hidden');
            segmentationSection.classList.add('hidden');
            recommendationsSection.classList.add('hidden');
            reportSection.classList.add('hidden');
            
            // Clear tables and charts
            tableHeader.innerHTML = '';
            tableBody.innerHTML = '';
            segmentProfiles.innerHTML = '';
            recommendationsTabs.innerHTML = '';
            recommendationsContent.innerHTML = '';
            reportContent.innerHTML = '';
        }
        
        // Perform segmentation on the data
        function performSegmentation() {
            // In a real application, this would use machine learning algorithms
            // For this demo, we'll simulate segmentation results
            
            const clusterCount = parseInt(document.getElementById('clusterCount').value) || 5;
            const segmentCount = clusterCount === 'auto' ? 5 : clusterCount;
            
            // Simulate clustering by randomly assigning segments
            segmentResults = {
                segmentDistribution: {},
                segmentProfiles: {},
                featureImportance: {}
            };
            
            // Create segment distribution
            for (let i = 1; i <= segmentCount; i++) {
                segmentResults.segmentDistribution[`Segment ${i}`] = 0;
            }
            
            // Assign segments to data
            currentData.forEach(item => {
                const randomSegment = Math.floor(Math.random() * segmentCount) + 1;
                const segmentName = `Segment ${randomSegment}`;
                item.segment = randomSegment;
                segmentResults.segmentDistribution[segmentName]++;
            });
            
            // Generate feature importance
            const features = Object.keys(currentData[0]).filter(key => key !== 'segment');
            features.forEach(feature => {
                segmentResults.featureImportance[feature] = Math.random();
            });
            
            // Sort features by importance
            const sortedFeatures = features.sort((a, b) => 
                segmentResults.featureImportance[b] - segmentResults.featureImportance[a]
            ).slice(0, 8); // Take top 8 features
            
            // Generate segment profiles based on data
            for (let i = 1; i <= segmentCount; i++) {
                const segmentName = `Segment ${i}`;
                const segmentData = currentData.filter(item => item.segment === i);
                
                segmentResults.segmentProfiles[segmentName] = {
                    size: segmentData.length,
                    percentage: (segmentData.length / currentData.length * 100).toFixed(1),
                    name: generateSegmentName(i),
                    description: generateSegmentDescription(i),
                    characteristics: {}
                };
                
                // Calculate average/common values for key features
                sortedFeatures.forEach(feature => {
                    const values = segmentData.map(item => item[feature]).filter(Boolean);
                    if (values.length > 0) {
                        if (typeof values[0] === 'number') {
                            // Calculate average for numeric values
                            const avg = values.reduce((sum, val) => sum + val, 0) / values.length;
                            segmentResults.segmentProfiles[segmentName].characteristics[feature] = parseFloat(avg.toFixed(2));
                        } else {
                            // Find most common value for non-numeric
                            const valueCounts = values.reduce((counts, value) => {
                                counts[value] = (counts[value] || 0) + 1;
                                return counts;
                            }, {});
                            
                            const mostCommonValue = Object.keys(valueCounts).reduce((a, b) => 
                                valueCounts[a] > valueCounts[b] ? a : b
                            );
                            
                            segmentResults.segmentProfiles[segmentName].characteristics[feature] = mostCommonValue;
                        }
                    }
                });
            }
            
            // Create visualization
            createSegmentDistributionChart();
            createFeatureImportanceChart();
            displaySegmentProfiles();
        }
        
        // Generate recommendations based on segments
        function generateRecommendations() {
            recommendationResults = {};
            
            // For each segment, generate marketing recommendations
            Object.keys(segmentResults.segmentProfiles).forEach(segmentName => {
                const segment = segmentResults.segmentProfiles[segmentName];
                
                recommendationResults[segmentName] = {
                    campaigns: generateCampaigns(segment),
                    channels: generateChannels(segment),
                    messages: generateMessages(segment),
                    timing: generateTiming(segment),
                    products: generateProducts(segment)
                };
            });
            
            // Create the recommendations UI
            displayRecommendations();
        }
        
        // Generate final report
        function generateReport() {
            const apiKeyProvided = apiKeyInput.value.trim().length > 0;
            
            let reportHTML = `
                <div class="mb-6">
                    <h3 class="text-xl font-semibold mb-3">General Analysis Summary</h3>
                    <p class="mb-2">The analyzed dataset contains <strong>${currentData.length}</strong> customer records and <strong>${Object.keys(currentData[0]).length}</strong> features.</p>
                    <p class="mb-2">Customers are divided into <strong>${Object.keys(segmentResults.segmentProfiles).length}</strong> different segments.</p>
                    ${apiKeyProvided ? 
                        '<p class="mb-2">Segment analysis and recommendations were performed using OpenAI API.</p>' : 
                        '<p class="mb-2 text-amber-600">Note: Since the OpenAI API key was not provided, segment analysis and recommendations were generated through simulation.</p>'
                    }
                </div>
                
                <div class="mb-6">
                    <h3 class="text-xl font-semibold mb-3">Segment Evaluation</h3>
                    <div class="space-y-4">
            `;
            
            // Add segment evaluations
            Object.keys(segmentResults.segmentProfiles).forEach(segmentName => {
                const segment = segmentResults.segmentProfiles[segmentName];
                
                reportHTML += `
                    <div class="p-4 rounded-md bg-gray-50">
                        <h4 class="font-medium text-lg mb-2">${segment.name}</h4>
                        <p class="text-gray-700 mb-3">${segment.description}</p>
                        <div class="flex items-center justify-between">
                            <span class="text-sm text-gray-600">${segment.percentage}% of customers</span>
                            <span class="font-medium">${segment.size} customers</span>
                        </div>
                    </div>
                `;
            });
            
            reportHTML += `
                </div>
            </div>
            
            <div class="mb-6">
                <h3 class="text-xl font-semibold mb-3">Marketing Strategy Summary</h3>
                <p class="mb-4">Customized marketing strategies for each customer segment are summarized below:</p>
                
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Segment</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Recommended Campaigns</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Ideal Communication Channels</th>
                            </tr>
                        </thead>
                        <tbody class="bg-white divide-y divide-gray-200">
            `;
            
            // Add marketing recommendations to table
            Object.keys(recommendationResults).forEach((segmentName, index) => {
                const recommendations = recommendationResults[segmentName];
                const segment = segmentResults.segmentProfiles[segmentName];
                
                reportHTML += `
                    <tr>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <div class="font-medium text-gray-900">${segment.name}</div>
                            <div class="text-sm text-gray-500">${segment.percentage}% of customers</div>
                        </td>
                        <td class="px-6 py-4">
                            <ul class="list-disc list-inside text-sm text-gray-700">
                                ${recommendations.campaigns.map(campaign => `<li>${campaign}</li>`).join('')}
                            </ul>
                        </td>
                        <td class="px-6 py-4">
                            <ul class="list-disc list-inside text-sm text-gray-700">
                                ${recommendations.channels.map(channel => `<li>${channel}</li>`).join('')}
                            </ul>
                        </td>
                    </tr>
                `;
            });
            
            reportHTML += `
                        </tbody>
                    </table>
                </div>
            </div>
            
            <div class="mb-6">
                <h3 class="text-xl font-semibold mb-3">Next Steps</h3>
                <ul class="list-disc list-inside space-y-2 text-gray-700">
                    <li>Customized marketing campaigns for identified segments should be implemented.</li>
                    <li>The effectiveness of recommended communication channels for each segment should be regularly measured.</li>
                    <li>Customer segmentation should be re-analyzed after 3 months.</li>
                    <li>Sales forecasts should be updated considering the impacts of segment-based strategies.</li>
                </ul>
            </div>
            `;
            
            // Update the report content
            reportContent.innerHTML = reportHTML;
        }
        
        // Create segment distribution chart
        function createSegmentDistributionChart() {
            const ctx = document.getElementById('segmentDistributionChart').getContext('2d');
            
            // Extract segment data
            const labels = Object.keys(segmentResults.segmentDistribution);
            const data = Object.values(segmentResults.segmentDistribution);
            
            // Create chart
            new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: labels,
                    datasets: [{
                        data: data,
                        backgroundColor: segmentColors.slice(0, labels.length),
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'right',
                            labels: {
                                font: {
                                    size: 12
                                },
                                boxWidth: 20
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const label = context.label;
                                    const value = context.raw;
                                    const percentage = Math.round(value / data.reduce((a, b) => a + b, 0) * 100);
                                    return `${label}: ${value} customers (${percentage}%)`;
                                }
                            }
                        }
                    }
                }
            });
        }
        
        // Create feature importance chart
        function createFeatureImportanceChart() {
            const ctx = document.getElementById('featureImportanceChart').getContext('2d');
            
            // Get top 8 features by importance
            const features = Object.keys(segmentResults.featureImportance)
                .sort((a, b) => segmentResults.featureImportance[b] - segmentResults.featureImportance[a])
                .slice(0, 8);
            
            const featureData = features.map(feature => segmentResults.featureImportance[feature]);
            
            // Create chart
            new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: features,
                    datasets: [{
                        label: 'Feature Importance',
                        data: featureData,
                        backgroundColor: 'rgba(54, 162, 235, 0.6)',
                        borderColor: 'rgba(54, 162, 235, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    indexAxis: 'y',
                    plugins: {
                        legend: {
                            display: false
                        },
                    },
                    scales: {
                        x: {
                            beginAtZero: true,
                            max: 1,
                            title: {
                                display: true,
                                text: 'Importance Level'
                            }
                        }
                    }
                }
            });
        }
        
        // Display segment profiles
        function displaySegmentProfiles() {
            segmentProfiles.innerHTML = '';
            
            Object.keys(segmentResults.segmentProfiles).forEach((segmentName, index) => {
                const segment = segmentResults.segmentProfiles[segmentName];
                const color = segmentColors[index % segmentColors.length].replace('0.8', '1');
                
                const card = document.createElement('div');
                card.className = 'bg-white rounded-lg shadow-sm border-t-4 p-5';
                card.style.borderTopColor = color;
                
                let characteristicsHTML = '';
                Object.entries(segment.characteristics).slice(0, 5).forEach(([feature, value]) => {
                    characteristicsHTML += `
                        <div class="flex justify-between items-center text-sm mb-1">
                            <span class="text-gray-600">${feature}:</span>
                            <span class="font-medium">${value}</span>
                        </div>
                    `;
                });
                
                card.innerHTML = `
                    <div class="flex justify-between items-center mb-3">
                        <h4 class="text-lg font-semibold">${segment.name}</h4>
                        <span class="px-2 py-1 bg-blue-100 text-blue-800 text-xs rounded-full font-medium">${segment.percentage}%</span>
                    </div>
                    <p class="text-gray-600 text-sm mb-4">${segment.description}</p>
                    <div class="mb-4">
                        <h5 class="font-medium text-gray-800 mb-2 text-sm">Key Features</h5>
                        ${characteristicsHTML}
                    </div>
                    <div class="text-right">
                        <span class="text-sm text-gray-500">${segment.size} customers</span>
                    </div>
                `;
                
                segmentProfiles.appendChild(card);
            });
        }
        
        // Display recommendations
        function displayRecommendations() {
            // Clear previous content
            recommendationsTabs.innerHTML = '';
            recommendationsContent.innerHTML = '';
            
            // Create tabs for each segment
            Object.keys(recommendationResults).forEach((segmentName, index) => {
                const segment = segmentResults.segmentProfiles[segmentName];
                const tabId = `tab-${segmentName.replace(/\s+/g, '-').toLowerCase()}`;
                
                // Create tab button
                const tabButton = document.createElement('button');
                tabButton.className = `px-4 py-2 text-sm font-medium ${index === 0 ? 'border-b-2 border-blue-500 text-blue-600' : 'text-gray-500 hover:text-gray-700'}`;
                tabButton.textContent = segment.name;
                tabButton.onclick = function() {
                    // Deactivate all tabs
                    Array.from(recommendationsTabs.children).forEach(tab => {
                        tab.classList.remove('border-b-2', 'border-blue-500', 'text-blue-600');
                        tab.classList.add('text-gray-500', 'hover:text-gray-700');
                    });
                    
                    // Hide all content
                    Array.from(recommendationsContent.children).forEach(content => {
                        content.classList.add('hidden');
                    });
                    
                    // Activate selected tab
                    tabButton.classList.remove('text-gray-500', 'hover:text-gray-700');
                    tabButton.classList.add('border-b-2', 'border-blue-500', 'text-blue-600');
                    
                    // Show selected content
                    document.getElementById(tabId).classList.remove('hidden');
                };
                
                recommendationsTabs.appendChild(tabButton);
                
                // Create content for the tab
                const recommendations = recommendationResults[segmentName];
                
                const contentDiv = document.createElement('div');
                contentDiv.id = tabId;
                contentDiv.className = index === 0 ? '' : 'hidden';
                
                contentDiv.innerHTML = `
                    <div class="bg-gray-50 rounded-lg p-4 mb-6">
                        <h3 class="text-xl font-semibold mb-2">${segment.name} Marketing Recommendations</h3>
                        <p class="text-gray-600">${segment.description}</p>
                        <div class="flex items-center mt-2">
                            <span class="text-sm bg-blue-100 text-blue-800 px-2 py-1 rounded-full mr-2">${segment.percentage}% of customers</span>
                            <span class="text-sm text-gray-500">${segment.size} customers</span>
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                        <!-- Campaign Recommendations -->
                        <div class="bg-white rounded-lg shadow-sm p-5 border-l-4 border-indigo-500">
                            <div class="flex items-center mb-4">
                                <i class="fas fa-bullhorn text-indigo-500 mr-3 text-xl"></i>
                                <h4 class="text-lg font-semibold">Recommended Campaigns</h4>
                            </div>
                            <ul class="space-y-2">
                                ${recommendations.campaigns.map(campaign => 
                                    `<li class="flex items-start">
                                        <i class="fas fa-check-circle text-green-500 mt-1 mr-2"></i>
                                        <span>${campaign}</span>
                                    </li>`
                                ).join('')}
                            </ul>
                        </div>
                        
                        <!-- Channel Recommendations -->
                        <div class="bg-white rounded-lg shadow-sm p-5 border-l-4 border-teal-500">
                            <div class="flex items-center mb-4">
                                <i class="fas fa-comments text-teal-500 mr-3 text-xl"></i>
                                <h4 class="text-lg font-semibold">Communication Channels</h4>
                            </div>
                            <ul class="space-y-2">
                                ${recommendations.channels.map(channel => 
                                    `<li class="flex items-start">
                                        <i class="fas fa-check-circle text-green-500 mt-1 mr-2"></i>
                                        <span>${channel}</span>
                                    </li>`
                                ).join('')}
                            </ul>
                        </div>
                        
                        <!-- Messaging Recommendations -->
                        <div class="bg-white rounded-lg shadow-sm p-5 border-l-4 border-purple-500">
                            <div class="flex items-center mb-4">
                                <i class="fas fa-comment-dots text-purple-500 mr-3 text-xl"></i>
                                <h4 class="text-lg font-semibold">Message Strategy</h4>
                            </div>
                            <ul class="space-y-2">
                                ${recommendations.messages.map(message => 
                                    `<li class="flex items-start">
                                        <i class="fas fa-check-circle text-green-500 mt-1 mr-2"></i>
                                        <span>${message}</span>
                                    </li>`
                                ).join('')}
                            </ul>
                        </div>
                        
                        <!-- Timing Recommendations -->
                        <div class="bg-white rounded-lg shadow-sm p-5 border-l-4 border-amber-500">
                            <div class="flex items-center mb-4">
                                <i class="fas fa-clock text-amber-500 mr-3 text-xl"></i>
                                <h4 class="text-lg font-semibold">Timing Recommendations</h4>
                            </div>
                            <ul class="space-y-2">
                                ${recommendations.timing.map(timing => 
                                    `<li class="flex items-start">
                                        <i class="fas fa-check-circle text-green-500 mt-1 mr-2"></i>
                                        <span>${timing}</span>
                                    </li>`
                                ).join('')}
                            </ul>
                        </div>
                        
                        <!-- Product Recommendations -->
                        <div class="bg-white rounded-lg shadow-sm p-5 border-l-4 border-rose-500">
                            <div class="flex items-center mb-4">
                                <i class="fas fa-gift text-rose-500 mr-3 text-xl"></i>
                                <h4 class="text-lg font-semibold">Product Recommendations</h4>
                            </div>
                            <ul class="space-y-2">
                                ${recommendations.products.map(product => 
                                    `<li class="flex items-start">
                                        <i class="fas fa-check-circle text-green-500 mt-1 mr-2"></i>
                                        <span>${product}</span>
                                    </li>`
                                ).join('')}
                            </ul>
                        </div>
                    </div>
                `;
                
                recommendationsContent.appendChild(contentDiv);
            });
        }
        
        // Helper function to generate segment names
        function generateSegmentName(segmentId) {
            const segmentNames = [
                'High Value Loyal Customers',
                'Medium Value Regular Customers',
                'New Potential High Value Customers',
                'Price Sensitive Customers',
                'New and Seasonal Customers',
                'Customers at Risk of Churning',
                'VIP Prestige Customers'
            ];
            
            return segmentId <= segmentNames.length ? 
                segmentNames[segmentId - 1] : 
                `Segment ${segmentId}`;
        }
        
        // Helper function to generate segment descriptions
        function generateSegmentDescription(segmentId) {
            const descriptions = [
                'Frequent shoppers with high average cart value, loyal to your brand.',
                'Reliable customers who shop regularly and spend moderately.',
                'New customers with high potential value despite being new.',
                'Customers who are sensitive to discounts and promotions, shopping based on price.',
                'Customers who shop seasonally and have not yet developed loyalty.',
                'Previously active customers whose shopping frequency has decreased.',
                'Top spending customers who require special attention and prestige.'
            ];
            
            return segmentId <= descriptions.length ? 
                descriptions[segmentId - 1] : 
                `Description for this segment has not been created yet.`;
        }
        
        // Helper function to generate campaign recommendations
        function generateCampaigns(segment) {
            const campaignSets = {
                'High Value Loyal Customers': [
                    'VIP early access program',
                    'Loyalty rewards and exclusive discounts',
                    'Referral program with invite-a-friend campaign'
                ],
                'Medium Value Regular Customers': [
                    'Discount coupons to increase purchase frequency',
                    'Combination offers to increase cart value',
                    'Long-term loyalty program membership'
                ],
                'New Potential High Value Customers': [
                    'Welcome package and first purchase discount',
                    'Product discovery program and personalized recommendations',
                    'Early loyalty program participation'
                ],
                'Price Sensitive Customers': [
                    'Limited-time discount opportunities',
                    'Quantity-based discount campaigns',
                    'Price matching guarantee'
                ],
                'New and Seasonal Customers': [
                    'Seasonal special offers',
                    'Brand promotion campaigns',
                    'Second purchase special discount'
                ],
                'Customers at Risk of Churning': [
                    'Return discount campaign',
                    'Reactivation special offers',
                    'We miss you campaign and survey'
                ],
                'VIP Prestige Customers': [
                    'VIP events with exclusive invitations',
                    'Personalized products and services',
                    'Priority customer service and concierge'
                ]
            };
            
            return campaignSets[segment.name] || [
                'Personalized campaign suggestions',
                'Segment-based special offers',
                'Opportunities based on customer value'
            ];
        }
        
        // Helper function to generate channel recommendations
        function generateChannels(segment) {
            const channelSets = {
                'High Value Loyal Customers': [
                    'Personalized email communication',
                    'Dedicated customer representative support',
                    'SMS and mobile app notifications'
                ],
                'Medium Value Regular Customers': [
                    'Regular email newsletters',
                    'SMS campaign notifications',
                    'Social media advertisements'
                ],
                'New Potential High Value Customers': [
                    'Personalized welcome emails',
                    'Mobile app notifications',
                    'Targeted social media campaigns'
                ],
                'Price Sensitive Customers': [
                    'Discount-focused email campaigns',
                    'SMS opportunity notifications',
                    'Advertisements on price comparison platforms'
                ],
                'New and Seasonal Customers': [
                    'Social media advertisements',
                    'General email marketing',
                    'Retargeting campaigns'
                ],
                'Customers at Risk of Churning': [
                    'Personalized return emails',
                    'Special offers via SMS',
                    'Direct mail campaigns'
                ],
                'VIP Prestige Customers': [
                    'One-on-one communication via phone',
                    'Customized email communication',
                    'Exclusive invitations and events'
                ]
            };
            
            return channelSets[segment.name] || [
                'Email marketing',
                'Social media campaigns',
                'SMS notifications'
            ];
        }
        
        // Helper function to generate messaging recommendations
        function generateMessages(segment) {
            const messageSets = {
                'High Value Loyal Customers': [
                    'Content that makes them feel privileged and special',
                    'Early access messages for new products',
                    'Loyalty and gratitude-focused communication'
                ],
                'Medium Value Regular Customers': [
                    'Value-focused messages',
                    'Rewarding regular purchases',
                    'Product recommendations and collection updates'
                ],
                'New Potential High Value Customers': [
                    'Welcome and brand story',
                    'Product quality and value emphasis',
                    'Personalized experience messages'
                ],
                'Price Sensitive Customers': [
                    'Price and value emphasis',
                    'Limited-time opportunity messages',
                    'Savings-focused content'
                ],
                'New and Seasonal Customers': [
                    'Brand values and promotional content',
                    'Seasonal product recommendations',
                    'Engaging content and campaigns'
                ],
                'Customers at Risk of Churning': [
                    'Missing and return messages',
                    'Missed opportunities and innovations',
                    'Feedback-requesting content'
                ],
                'VIP Prestige Customers': [
                    'Premium and luxury-focused content',
                    'Personalized special offer messages',
                    'Exclusive event invitations'
                ]
            };
            
            return messageSets[segment.name] || [
                'Content tailored to segment needs',
                'Personalized messaging',
                'Communication aligned with brand values'
            ];
        }
        
        // Helper function to generate timing recommendations
        function generateTiming(segment) {
            const timingSets = {
                'High Value Loyal Customers': [
                    'Personalized timing based on previous shopping data',
                    'Weekly VIP opportunities and updates',
                    'Notification 48 hours before new collection launch'
                ],
                'Medium Value Regular Customers': [
                    'Follow-up communication 15-20 days after last purchase',
                    'Bi-weekly regular content and opportunities',
                    'Reminders based on shopping frequency'
                ],
                'New Potential High Value Customers': [
                    'Follow-up within 3-5 days after first purchase',
                    'Weekly updates and product recommendations during the first month',
                    'Loyalty program invitation after second purchase'
                ],
                'Price Sensitive Customers': [
                    'Notifications before major discount periods',
                    'Weekend special opportunities',
                    'Early access notifications for end-of-season discounts'
                ],
                'New and Seasonal Customers': [
                    'Special campaigns during seasonal changes',
                    'Reminders before holidays and special days',
                    'Reminder campaigns 30 days after last purchase'
                ],
                'Customers at Risk of Churning': [
                    'Return campaign 60-90 days after last purchase',
                    'Reminder communication during special days and holidays',
                    'Notification 24 hours before major seasonal discount start'
                ],
                'VIP Prestige Customers': [
                    'Personalized communication on special days (birthday, anniversary)',
                    'Invitation 1-2 weeks before special events',
                    'Monthly VIP collection and opportunities'
                ]
            };
            
            return timingSets[segment.name] || [
                'Weekly regular content sharing',
                'Communication following last purchase',
                'Special day and opportunity notifications'
            ];
        }
        
        // Helper function to generate product recommendations
        function generateProducts(segment) {
            const productSets = {
                'High Value Loyal Customers': [
                    'Premium product collection',
                    'Limited production special products',
                    'Complementary product sets and accessory recommendations'
                ],
                'Medium Value Regular Customers': [
                    'Most preferred products',
                    'Price-performance focused products',
                    'Complementary products based on previous purchases'
                ],
                'New Potential High Value Customers': [
                    'Introductory product sets',
                    'Entry-level premium products',
                    'Most popular and liked products'
                ],
                'Price Sensitive Customers': [
                    'Discounted products and opportunities',
                    'Affordable alternatives',
                    'Bulk purchase discounts and product packages'
                ],
                'New and Seasonal Customers': [
                    'Seasonal special products',
                    'Trend and new collection products',
                    'Entry-level products'
                ],
                'Customers at Risk of Churning': [
                    'New versions related to previous purchases',
                    'Special discounted products',
                    'Re-entry opportunities and packages'
                ],
                'VIP Prestige Customers': [
                    'Special design and personalized products',
                    'Collection pieces and luxury products',
                    'Pre-order and special production opportunities'
                ]
            };
            
            return productSets[segment.name] || [
                'Products suitable for customer profile',
                'Complementary product recommendations',
                'Most popular products'
            ];
        }
        
        // Initialize any automatic process
        document.addEventListener('DOMContentLoaded', function() {
            // If you want any automatic initialization, add it here
            
            // Simulate having API key - production would use real key
            apiKeyInput.value = "sk_test_********************";
        });
    </script>
</body>
</html>